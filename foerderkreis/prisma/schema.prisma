// Prisma Schema for Stundenglas (SdL App)
// Volunteer hour tracking & job marketplace for Schule des Lebens

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// NextAuth.js Models
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// Application Models
// ============================================

model User {
  id                  String            @id @default(cuid())
  email               String            @unique
  emailVerified       DateTime?         @map("email_verified")
  firstName           String            @default("") @map("first_name")
  lastName            String            @default("") @map("last_name")
  avatarUrl           String?           @map("avatar_url")
  bio                 String?
  skillTags           String[]          @default([]) @map("skill_tags")
  role                UserRole          @default(PARENT)
  privacyMode         Boolean           @default(false) @map("privacy_mode")
  onboardingCompleted Boolean           @default(false) @map("onboarding_completed")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  // Relations
  familyId         String?           @map("family_id")
  family           Family?           @relation(fields: [familyId], references: [id], onDelete: SetNull)
  accounts         Account[]
  sessions         Session[]
  kreisMemberships KreisMembership[]
  volunteerHours   VolunteerHour[]
  postedJobs       Job[]             @relation("PostedJobs")
  jobClaims        JobClaim[]

  @@map("users")
}

enum UserRole {
  PARENT
  ADMIN
  CIRCLE_LEAD

  @@map("user_role")
}

model Family {
  id                     String   @id @default(cuid())
  name                   String
  inviteCode             String   @unique @default(cuid()) @map("invite_code")
  monthlyHourTarget      Decimal  @default(10.0) @map("monthly_hour_target") @db.Decimal(5, 2)
  yearlyLegalMinimum     Decimal  @default(20.0) @map("yearly_legal_minimum") @db.Decimal(5, 2)
  hourlyCompensationRate Decimal  @default(30.0) @map("hourly_compensation_rate") @db.Decimal(6, 2)
  isActive               Boolean  @default(true) @map("is_active")
  notes                  String?
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  // Relations
  users            User[]
  volunteerHours   VolunteerHour[]
  emailOutreachLog EmailOutreachLog[]

  @@map("families")
}

model Kreis {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  icon        String?
  color       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  memberships    KreisMembership[]
  jobs           Job[]
  volunteerHours VolunteerHour[]

  @@map("kreise")
}

model KreisMembership {
  userId   String         @map("user_id")
  kreisId  String         @map("kreis_id")
  role     KreisMemberRole @default(MEMBER)
  joinedAt DateTime       @default(now()) @map("joined_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  kreis Kreis @relation(fields: [kreisId], references: [id], onDelete: Cascade)

  @@id([userId, kreisId])
  @@map("kreis_memberships")
}

enum KreisMemberRole {
  MEMBER
  LEAD

  @@map("kreis_member_role")
}

model Job {
  id            String     @id @default(cuid())
  title         String
  description   String?
  estimatedHours Decimal   @default(1.0) @map("estimated_hours") @db.Decimal(5, 2)
  urgency       JobUrgency @default(NORMAL)
  status        JobStatus  @default(OPEN)
  location      String?
  skillsNeeded  String[]   @default([]) @map("skills_needed")
  dueDate       DateTime?  @map("due_date") @db.Date
  maxClaimants  Int        @default(1) @map("max_claimants")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  kreisId  String?    @map("kreis_id")
  kreis    Kreis?     @relation(fields: [kreisId], references: [id], onDelete: SetNull)
  postedBy String     @map("posted_by")
  poster   User       @relation("PostedJobs", fields: [postedBy], references: [id], onDelete: Cascade)
  claims   JobClaim[]
  volunteerHours VolunteerHour[]

  @@map("jobs")
}

enum JobUrgency {
  LOW
  NORMAL
  HIGH
  CRITICAL

  @@map("job_urgency")
}

enum JobStatus {
  OPEN
  CLAIMED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@map("job_status")
}

model JobClaim {
  id          String         @id @default(cuid())
  status      JobClaimStatus @default(CLAIMED)
  claimedAt   DateTime       @default(now()) @map("claimed_at")
  completedAt DateTime?      @map("completed_at")

  // Relations
  jobId  String @map("job_id")
  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([jobId, userId])
  @@map("job_claims")
}

enum JobClaimStatus {
  CLAIMED
  COMPLETED
  WITHDRAWN

  @@map("job_claim_status")
}

model VolunteerHour {
  id            String   @id @default(cuid())
  hours         Decimal  @db.Decimal(5, 2)
  description   String
  datePerformed DateTime @map("date_performed") @db.Date
  flagged       Boolean  @default(false)
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  userId   String  @map("user_id")
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  familyId String  @map("family_id")
  family   Family  @relation(fields: [familyId], references: [id], onDelete: Cascade)
  kreisId  String? @map("kreis_id")
  kreis    Kreis?  @relation(fields: [kreisId], references: [id], onDelete: SetNull)
  jobId    String? @map("job_id")
  job      Job?    @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@index([familyId])
  @@index([userId])
  @@index([datePerformed])
  @@index([familyId, datePerformed])
  @@map("volunteer_hours")
}

model EmailOutreachLog {
  id        String   @id @default(cuid())
  emailType String   @map("email_type")
  subject   String
  sentAt    DateTime @default(now()) @map("sent_at")
  metadata  Json?

  // Relations
  familyId String @map("family_id")
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@map("email_outreach_log")
}
